services:
  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - /etc/letsencrypt/live/ofour-app.duckdns.org/:/etc/letsencrypt/live/ofour-app.duckdns.org/
      - /etc/letsencrypt/live/api-app.duckdns.org/:/etc/letsencrypt/live/api-app.duckdns.org/
      - ./ssl_certif/:/etc/nginx/ssl/
    ports:
      - "80:80"
      - "443:443"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [node.role == manager]
    networks:
      - web

  frontend:
    image: nor5/frontend:latest
    networks:
      - web
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure


  backend:
    image: nor5/backend:latest
    volumes:
      - /var/.env:/app/.env
    command: >
     sh -c "php artisan config:cache &&
            php artisan cache:clear &&
            php artisan serve --host=0.0.0.0 --port=8000"
    networks:
      - web
    deploy:
      replicas: 3
      update_config:
        parallelism: 2
        delay: 10s
      restart_policy:
        condition: on-failure


networks:
  web:
    driver: overlay

